# Plan: Fix Cartridge Drag-and-Drop Not Working Sometimes

## Problem Analysis

The drag-and-drop mechanism sometimes fails even when you drag the cartridge directly over the console.

### Root Cause

In `CoffreFortSection.tsx` at lines 198-204:

```tsx
onDragEnd={(x, y) => {
  if (checkInsideDropZone(x, y)) {
    handleCartridgeInsert(cartridge.id);
  }
  // ...
}}
```

The `onDragEnd` callback from Framer Motion uses `info.point.x` and `info.point.y` which represents the **pointer position** at the end of the drag. The drop zone detection (`checkInsideDropZone`) checks if this exact point falls within the console's bounding box.

### Why it Fails Sometimes

1. **Drag elastic/snap behavior**: With `dragSnapToOrigin` and `dragElastic={0.1}`, when you release, the cartridge may start snapping back before coordinates are captured

2. **Point vs Element mismatch**: `info.point` gives the pointer position, not the center of the dragged element. If you grab the cartridge by its edge, the drop detection may fail even if visually the cartridge overlaps the console

3. **Strict inside check**: `checkInsideDropZone` requires the point to be strictly inside with 0 tolerance, while `checkNearDropZone` has a 100px threshold

---

## Options

### Option A: Increase Drop Zone Tolerance (Quick Fix)
Add threshold to `checkInsideDropZone`:

```tsx
const checkInsideDropZone = useCallback((x: number, y: number) => {
  if (!dropZoneRef.current) return false;
  const rect = dropZoneRef.current.getBoundingClientRect();
  const threshold = 30; // Add tolerance
  return (
    x >= rect.left - threshold &&
    x <= rect.right + threshold &&
    y >= rect.top - threshold &&
    y <= rect.bottom + threshold
  );
}, []);
```

### Option B: Use `isNearDropZone` State (Recommended)
Use the already-tracked state which updates continuously during drag:

```tsx
onDragEnd={() => {
  if (isNearDropZone) {
    handleCartridgeInsert(cartridge.id);
  }
  setIsDragging(false);
  setIsNearDropZone(false);
}}
```

This is more reliable because `isNearDropZone` is updated in real-time during the drag via `onDrag`.

### Option C: Combine Both Checks
Use `isNearDropZone` OR a tolerant inside check for maximum reliability.

---

## Recommendation: Option B

Use `isNearDropZone` for drop detection since it's already being tracked accurately during the drag operation with a 100px threshold. Minimal code changes required.

---

## Implementation Steps

1. Modify `onDragEnd` callback in `CoffreFortSection.tsx` to use `isNearDropZone` instead of re-checking position
2. Remove unused `x, y` parameters from the callback

---

## Files to Modify

1. `src/components/sections/CoffreFortSection.tsx` - Lines 198-204

---

## Awaiting Approval

Ready to implement Option B?
